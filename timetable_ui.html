<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aƒüƒ±llƒ± D…ôrs C…ôdv…ôli ‚Äî Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --pr50: #fce8ea;
            --pr100: #f9d2d5;
            --pr200: #f4a4ab;
            --pr300: #ee7781;
            --pr400: #e94957;
            --pr500: #e31c2d;
            --pr600: #b61624;
            --pr700: #88111b;
            --pr800: #5b0b12;
            --pr900: #2d0609;
            --pr950: #200406;
            --hd50: #eff9eb;
            --hd100: #def4d7;
            --hd200: #bee8b0;
            --hd300: #9ddd88;
            --hd400: #7dd161;
            --hd500: #5cc639;
            --hd600: #4a9e2e;
            --hd700: #377722;
            --hd800: #254f17;
            --hd900: #12280b;
            --hd950: #0d1c08;
            --fb50: #edf7f8;
            --fb100: #dbf0f0;
            --fb200: #b6e0e2;
            --fb300: #92d1d3;
            --fb400: #6dc2c5;
            --fb500: #49b3b6;
            --fb600: #3a8f92;
            --fb700: #2c6b6d;
            --fb800: #1d4749;
            --fb900: #0f2424;
            --fb950: #0a191a;
            --ce50: #edf3f7;
            --ce100: #dce8ef;
            --ce200: #334155;
            --ce300: #475569;
            --ce400: #64748b;
            --ce500: #4e8bb1;
            --ce600: #3e6f8e;
            --ce700: #94a3b8;
            --ce800: #94a3b8;
            --ce900: #101c23;
            --ce950: #0b1319;
            --on50: #ecf1f9;
            --on100: #0f172a;
            --on200: #b3c8e6;
            --on300: #8cacd9;
            --on400: #6690cc;
            --on500: #4075bf;
            --on600: #335d99;
            --on700: #1e293b;
            --on800: #f1f5f9;
            --on900: #ffffff;
            --on950: #f8fafc;
        }

        * {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        body {
            background: var(--on950);
            color: #0f172a;
            margin: 0;
        }

        .cell-split {
            position: relative;
            overflow: hidden;
        }

        .cell-split::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 141%;
            height: 1px;
            background: rgba(113, 162, 193, 0.25);
            transform-origin: top left;
            transform: rotate(28deg);
            pointer-events: none;
            z-index: 5;
        }

        .cell-even-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            z-index: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 3px;
        }

        .cell-odd-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            z-index: 1;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 3px;
        }

        .drop-target-even {
            background: rgba(78, 139, 177, 0.18) !important;
        }

        .drop-target-odd {
            background: rgba(92, 198, 57, 0.15) !important;
        }

        .drop-target-both {
            background: linear-gradient(135deg, rgba(78, 139, 177, 0.12), rgba(92, 198, 57, 0.12)) !important;
        }

        .lesson-card {
            cursor: grab;
            transition: all .2s ease;
        }

        .lesson-card:active {
            cursor: grabbing;
        }

        .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .placed-pill {
            animation: fadeIn .3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(.85)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        .blocked-x {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 900;
            color: #f87171;
            pointer-events: none;
            z-index: 10;
            opacity: .45;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--on700);
            border-radius: 3px;
        }

        .teacher-active {
            box-shadow: 0 0 0 2px rgba(78, 139, 177, 0.6), 0 0 20px rgba(78, 139, 177, 0.15);
        }

        .toast {
            animation: slideIn .3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .modal-overlay {
            animation: fadeOverlay .2s ease;
        }

        @keyframes fadeOverlay {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        .modal-content {
            animation: scaleIn .25s ease;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(.95)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        .tab-active {
            border-bottom: 2px solid var(--ce500);
            color: #0f172a;
        }

        /* Mobile sidebar */
        .sidebar-overlay {
            display: none;
        }

        @media(max-width:768px) {
            .sidebar-overlay.open {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(9, 16, 27, 0.7);
                z-index: 40;
            }

            .app-sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                bottom: 0;
                z-index: 50;
                width: 280px;
                transition: left .3s ease;
            }

            .app-sidebar.open {
                left: 0;
            }

            .grid-main {
                padding: 12px !important;
            }
        }

        /* ‚îÄ‚îÄ PDF / Print Styles ‚îÄ‚îÄ */
        @media print {
            body {
                background: #fff !important;
                margin: 0;
                padding: 0;
            }

            .app-sidebar,
            header,
            .sidebar-overlay,
            .toast,
            .admin-btn,
            .print-hide {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
            }

            .timetable-grid {
                background: #fff !important;
                border: 1px solid #000;
            }

            .cell-split {
                border: 1px solid #444 !important;
                break-inside: avoid;
                height: auto !important;
                min-height: 80px;
            }

            * {
                text-shadow: none !important;
                box-shadow: none !important;
            }

            .print-header {
                display: block !important;
                padding: 20px 0;
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
            }

            .print-header h1 {
                font-size: 24px;
                font-weight: bold;
                margin: 0;
                color: #000 !important;
            }

            .print-header p {
                font-size: 14px;
                margin: 5px 0 0;
                color: #333 !important;
            }
        }

        .print-header {
            display: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect, useMemo } = React;

        const DAYS = [
            { id: 0, name: 'Bazar ert…ôsi', short: 'B.e.' },
            { id: 1, name: '√á…ôr≈ü…ônb…ô ax≈üamƒ±', short: '√á.a.' },
            { id: 2, name: '√á…ôr≈ü…ônb…ô', short: '√á…ôr.' },
            { id: 3, name: 'C√ºm…ô ax≈üamƒ±', short: 'C.a.' },
            { id: 4, name: 'C√ºm…ô', short: 'C√ºm…ô' },
        ];
        const SLOTS = [
            { id: 0, shift: 'S…ôh…ôr', num: 'I', time: '08:00 ‚Äì 09:20' },
            { id: 1, shift: 'S…ôh…ôr', num: 'II', time: '09:35 ‚Äì 10:55' },
            { id: 2, shift: 'S…ôh…ôr', num: 'III', time: '11:10 ‚Äì 12:30' },
            { id: 3, shift: 'G√ºnorta', num: 'IV', time: '12:45 ‚Äì 14:05' },
            { id: 4, shift: 'G√ºnorta', num: 'V', time: '14:20 ‚Äì 15:40' },
            { id: 5, shift: 'G√ºnorta', num: 'VI', time: '15:55 ‚Äì 17:15' },
        ];
        const COLOR_PALETTE = ['#4e8bb1', '#5cc639', '#49b3b6', '#e94957', '#6690cc', '#7dd161', '#ee7781', '#64748b', '#9ddd88', '#4075bf'];
        const INIT_TEACHERS = [
            { id: 1, name: 'Eyyubov Ramazan', department: 'Riyaziyyat', color: '#4e8bb1', blockedSlots: [] },
            { id: 2, name: 'Qasƒ±mzad…ô T…ôran…ô', department: 'S∆èT∆èM', color: '#e31c2d', blockedSlots: [] },
            { id: 3, name: 'G√∂y√º≈ül√º R…ôvan…ô', department: 'Komp√ºter elml…ôri', color: '#5cc639', blockedSlots: [] },
            { id: 4, name: '∆èhm…ôdov R…ôfail', department: 'Proqramla≈üdƒ±rma', color: '#f59e0b', blockedSlots: [] },
            { id: 5, name: 'Seidova Emma', department: 'ƒ∞ngilis dili', color: '#8b5cf6', blockedSlots: [] },
            { id: 6, name: 'Niyazi S…ônan', department: '≈û…ôb…ôk…ô', color: '#ec4899', blockedSlots: [] },
            { id: 7, name: 'S√ºleymanova N…ôrgiz', department: 'Komp√ºter arxitekturasƒ±', color: '#14b8a6', blockedSlots: [] },
        ];
        const INIT_LESSONS = [
            { id: 'L1', teacherId: 1, subject: 'Diskret riyaziyyat', group: '758ITS', totalHours: 45 },
            { id: 'L2', teacherId: 2, subject: 'S∆èT∆èM', group: '758ITS', totalHours: 30 },
            { id: 'L3', teacherId: 3, subject: 'Obyekt y√∂nl√º proqramla≈üdƒ±rma', group: '758ITS', totalHours: 60 },
            { id: 'L4', teacherId: 4, subject: 'M√ºasir proqramla≈üdƒ±rma dill…ôri', group: '758ITS', totalHours: 60 },
            { id: 'L5', teacherId: 5, subject: 'ƒ∞≈üg√ºzar ingilis dili', group: '758ITS', totalHours: 30 },
            { id: 'L6', teacherId: 6, subject: 'Komp√ºter ≈ü…ôb…ôk…ôl…ôri-1', group: '758ITS', totalHours: 45 },
            { id: 'L7', teacherId: 7, subject: 'Komp√ºter arxitekturasƒ±-2', group: '758ITS', totalHours: 45 },
        ];

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        const firebaseConfig = {
            apiKey: "AIzaSyCKs9QPJMGpz4RRT6zoaMO2S92bhEw1ZVk",
            authDomain: "cedvel.firebaseapp.com",
            databaseURL: "https://cedvel-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cedvel",
            storageBucket: "cedvel.firebasestorage.app",
            messagingSenderId: "717991510961",
            appId: "1:717991510961:web:edccf25a5c0d7bd4233390"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function isTeacherAvailable(teacher, dayId, slotId) {
            return !(teacher.blockedSlots || []).includes(`${dayId}-${slotId}`);
        }
        function parityConflicts(p1, p2) { return p1 === 'both' || p2 === 'both' || p1 === p2; }

        // Hour splitting rules
        const HOUR_OPTIONS = [30, 45, 60, 75, 90];
        const SESSIONS = { both: 15, even: 7, odd: 8 }; // Alt=7, √úst=8, H…ôr=15
        const BLOCK_MINUTES = 80;
        function splitHours(totalHours) {
            const map = { 30: [15, 15], 45: [30, 15], 60: [30, 30], 75: [45, 30], 90: [60, 30] };
            const [lec, sem] = map[totalHours] || [Math.ceil(totalHours / 2), Math.floor(totalHours / 2)];
            return { lecture: lec, seminar: sem };
        }
        function hoursToBlocks(hours) {
            const full = Math.floor(hours / 30);
            const half = (hours % 30) / 15;
            return { full, half: Math.round(half) };
        }
        function getPlacedHoursByType(placements, lessonId) {
            let lec = 0, sem = 0;
            placements.filter(p => p.lessonId === lessonId).forEach(p => {
                const h = p.parity === 'both' ? 30 : 15;
                if (p.type === 'seminar') sem += h; else lec += h;
            });
            return { lecture: lec, seminar: sem };
        }
        // Check if same lesson already has M or S in adjacent slot on same day
        function hasAdjacentSameSubject(placementList, lessonId, dayId, slotId, parity) {
            return placementList.some(p => {
                if (p.lessonId !== lessonId || p.dayId !== dayId) return false;
                if (!parityConflicts(p.parity, parity)) return false;
                return Math.abs(p.slotId - slotId) === 1; // adjacent slot
            });
        }
        // Count how many blocks a lesson has on a given day
        function countOnDay(placementList, lessonId, dayId) {
            return placementList.filter(p => p.lessonId === lessonId && p.dayId === dayId).length;
        }
        // Get session count for a placement
        function getSessionCount(parity) { return SESSIONS[parity] || SESSIONS.both; }

        let _nextId = 100; function genId() { return 'L_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
        let _nextTId = 10; function genTId() { return Date.now() + Math.floor(Math.random() * 100000); }

        /* ‚îÄ‚îÄ Small Components ‚îÄ‚îÄ */
        function ParityBadge({ parity, small = false }) {
            const c = {
                both: { l: 'H…ôr h…ôft…ô', bg: 'background:rgba(78,139,177,0.2)', dot: 'background:#4e8bb1' },
                even: { l: 'Alt h…ôft…ô', bg: 'background:rgba(64,117,191,0.2)', dot: 'background:#6690cc' },
                odd: { l: '√úst h…ôft…ô', bg: 'background:rgba(92,198,57,0.2)', dot: 'background:#5cc639' }
            }[parity];
            return <span className={`inline-flex items-center gap-1 rounded-full ${small ? 'text-[8px] px-1 py-0' : 'text-[10px] px-1.5 py-0.5'} font-medium`}
                style={{ [c.bg.split(':')[0]]: c.bg.split(':')[1], color: '#0f172a' }}>
                <span className="w-1.5 h-1.5 rounded-full" style={{ background: c.dot.split(':')[1] }} />{c.l}</span>;
        }
        function Toast({ msg, type }) {
            const st = type === 'error' ? { bg: 'rgba(227,28,45,0.15)', border: 'rgba(233,73,87,0.3)', color: '#f4a4ab' }
                : type === 'success' ? { bg: 'rgba(92,198,57,0.15)', border: 'rgba(125,209,97,0.3)', color: '#bee8b0' }
                    : { bg: 'rgba(78,139,177,0.15)', border: 'rgba(15,23,42,0.3)', color: '#334155' };
            return <div className="toast fixed top-4 right-4 z-[200] px-4 py-2.5 rounded-xl text-sm font-medium shadow-2xl backdrop-blur-xl"
                style={{ background: st.bg, borderColor: st.border, borderWidth: 1, borderStyle: 'solid', color: st.color }}>{msg}</div>;
        }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
        function Modal({ open, onClose, title, children, wide = false }) {
            if (!open) return null;
            return <div className="modal-overlay fixed inset-0 z-[100] flex items-center justify-center" style={{ background: 'rgba(15,23,42,0.5)' }} onClick={onClose}>
                <div className={`modal-content rounded-2xl shadow-2xl ${wide ? 'w-[700px] max-w-[95vw]' : 'w-[480px] max-w-[95vw]'} max-h-[90vh] overflow-y-auto`}
                    style={{ background: '#ffffff', border: '1px solid #e2e8f0' }} onClick={e => e.stopPropagation()}>
                    <div className="flex items-center justify-between px-5 py-3.5 sm:px-6 sm:py-4" style={{ borderBottom: '1px solid #e2e8f0' }}>
                        <h2 className="text-base font-bold">{title}</h2>
                        <button onClick={onClose} className="w-7 h-7 rounded-lg flex items-center justify-center transition" style={{ background: '#e2e8f0', color: '#475569' }}>‚úï</button>
                    </div>
                    <div className="px-5 py-4 sm:px-6 sm:py-5">{children}</div>
                </div>
            </div >;
        }

        /* ‚îÄ‚îÄ Teacher Form ‚îÄ‚îÄ */
        function TeacherForm({ teacher, onSave, onClose }) {
            const isEdit = !!teacher?.id;
            const [name, setName] = useState(teacher?.name || '');
            const [dept, setDept] = useState(teacher?.department || '');
            const [color, setColor] = useState(teacher?.color || COLOR_PALETTE[Math.floor(Math.random() * COLOR_PALETTE.length)]);
            const [blocked, setBlocked] = useState(teacher?.blockedSlots || []);

            const toggleCell = (d, s) => { const k = `${d}-${s}`; setBlocked(p => p.includes(k) ? p.filter(x => x !== k) : [...p, k]); };
            const toggleRow = (s) => { const rowKeys = DAYS.map(d => `${d.id}-${s}`); const allBlocked = rowKeys.every(k => blocked.includes(k)); if (allBlocked) setBlocked(p => p.filter(k => !rowKeys.includes(k))); else setBlocked(p => [...new Set([...p, ...rowKeys])]); };
            const toggleCol = (d) => { const colKeys = SLOTS.map((_, s) => `${d}-${s}`); const allBlocked = colKeys.every(k => blocked.includes(k)); if (allBlocked) setBlocked(p => p.filter(k => !colKeys.includes(k))); else setBlocked(p => [...new Set([...p, ...colKeys])]); };

            const handleSave = () => { if (!name.trim()) return; onSave({ id: teacher?.id || genTId(), name: name.trim(), department: dept.trim(), color, blockedSlots: blocked }); onClose(); };
            const ic = "w-full rounded-lg px-3 py-2 text-sm placeholder-opacity-40 focus:outline-none transition";
            const iStyle = { background: '#ffffff', border: '1px solid rgba(15,23,42,0.15)', color: '#0f172a' };
            return <div className="space-y-5">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div><label className="block text-xs mb-1.5" style={{ color: '#475569' }}>Ad, Soyad *</label><input className={ic} style={iStyle} value={name} onChange={e => setName(e.target.value)} placeholder="Dos. N…ôsibov" /></div>
                    <div><label className="block text-xs mb-1.5" style={{ color: '#475569' }}>Kafedra</label><input className={ic} style={iStyle} value={dept} onChange={e => setDept(e.target.value)} placeholder="Elektronika" /></div>
                </div>
                <div><label className="block text-xs mb-1.5" style={{ color: '#475569' }}>R…ông</label>
                    <div className="flex gap-2 flex-wrap">{COLOR_PALETTE.map(c => <button key={c} className={`w-7 h-7 rounded-lg border-2 transition ${color === c ? 'border-white scale-110' : 'border-transparent hover:border-white/30'}`} style={{ background: c }} onClick={() => setColor(c)} />)}</div>
                </div>
                <div>
                    <label className="block text-xs mb-1.5" style={{ color: '#475569' }}>M√∂vcudluq C…ôdv…ôli (Qƒ±rmƒ±zƒ± = Bloklanƒ±b)</label>
                    <div className="overflow-x-auto rounded-lg" style={{ border: '1px solid #e2e8f0' }}>
                        <table className="w-full text-center text-[10px] border-collapse bg-white">
                            <thead>
                                <tr>
                                    <th className="p-1.5 border-b border-r text-slate-400 font-normal w-12">Saat \ G√ºn</th>
                                    {DAYS.map(d => <th key={d.id} className="p-1.5 border-b border-r cursor-pointer hover:bg-slate-50 transition font-semibold" onClick={() => toggleCol(d.id)}>{d.short}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {SLOTS.map((s, sIdx) => (
                                    <tr key={sIdx}>
                                        <td className="p-1.5 border-b border-r font-semibold cursor-pointer hover:bg-slate-50 transition w-12 text-slate-500" onClick={() => toggleRow(sIdx)}>{sIdx + 1}</td>
                                        {DAYS.map(d => {
                                            const isB = blocked.includes(`${d.id}-${sIdx}`);
                                            return <td key={`${d.id}-${sIdx}`} className="p-0 border-b border-r">
                                                <button className={`w-full h-8 transition-colors ${isB ? 'bg-red-100 hover:bg-red-200' : 'bg-emerald-50 hover:bg-emerald-100'}`} onClick={() => toggleCell(d.id, sIdx)}>
                                                    {isB ? <span className="text-red-500 font-bold">‚úï</span> : <span className="text-emerald-500">‚úì</span>}
                                                </button>
                                            </td>
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <p className="text-[9px] mt-1.5 text-slate-400">ƒ∞pucu: S√ºtun (g√ºn) v…ô ya s…ôtir (saat) ba≈ülƒ±ƒüƒ±na klikl…ôy…ôr…ôk b√ºt√∂vl√ºkd…ô h…ômin s√ºtun v…ô ya s…ôtri bloklaya/a√ßa bil…ôrsiniz.</p>
                </div>
                <div className="flex justify-end gap-2 pt-2">
                    <button className="px-4 py-2 rounded-lg text-sm transition" style={{ background: '#e2e8f0', color: '#475569' }} onClick={onClose}>L…ôƒüv et</button>
                    <button className="px-5 py-2 rounded-lg text-sm font-semibold transition disabled:opacity-40" style={{ background: '#4e8bb1', color: '#fff' }} disabled={!name.trim()} onClick={handleSave}>{isEdit ? 'Yadda saxla' : '∆èlav…ô et'}</button>
                </div>
            </div>;
        }

        /* ‚îÄ‚îÄ Lesson Form ‚îÄ‚îÄ */
        function LessonForm({ lesson, teachers, onSave, onClose, initialTeacherId }) {
            const isEdit = !!lesson;
            const [teacherId, setTeacherId] = useState(lesson?.teacherId || initialTeacherId || teachers[0]?.id || 0);
            const [subject, setSubject] = useState(lesson?.subject || '');
            const [group, setGroup] = useState(lesson?.group || '');
            const [totalHours, setTotalHours] = useState(lesson?.totalHours || 30);
            const split = splitHours(Number(totalHours));
            const lecBlocks = hoursToBlocks(split.lecture);
            const semBlocks = hoursToBlocks(split.seminar);
            const handleSave = () => { if (!subject.trim() || !group.trim()) return; onSave({ id: lesson?.id || genId(), teacherId: Number(teacherId), subject: subject.trim(), group: group.trim(), totalHours: Number(totalHours) }); onClose(); };
            const ic = "w-full rounded-lg px-3 py-2 text-sm focus:outline-none transition";
            const iStyle = { background: '#ffffff', border: '1px solid rgba(15,23,42,0.15)', color: '#0f172a' };
            return <div className="space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div><label className="block text-xs mb-1.5" style={{ color: '#475569' }}>F…ônn adƒ± *</label><input className={ic} style={iStyle} value={subject} onChange={e => setSubject(e.target.value)} placeholder="Riyaziyyat" /></div>
                    <div><label className="block text-xs mb-1.5" style={{ color: '#475569' }}>Qrup *</label><input className={ic} style={iStyle} value={group} onChange={e => setGroup(e.target.value)} placeholder="758ITS" /></div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div><label className="block text-xs mb-1.5" style={{ color: '#475569' }}>M√º…ôllim</label><select className={ic} style={iStyle} value={teacherId} onChange={e => setTeacherId(e.target.value)}>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></div>
                    <div><label className="block text-xs mb-1.5" style={{ color: '#475569' }}>√úmumi saat</label>
                        <select className={ic} style={iStyle} value={totalHours} onChange={e => setTotalHours(Number(e.target.value))}>
                            {HOUR_OPTIONS.map(h => <option key={h} value={h}>{h} saat</option>)}
                        </select>
                    </div>
                </div>
                <div className="rounded-lg p-2.5" style={{ background: '#f1f5f9', border: '1px solid #e2e8f0' }}>
                    <p className="text-[10px] font-semibold mb-1.5" style={{ color: '#475569' }}>Avtomatik b√∂lg√º:</p>
                    <div className="flex gap-3 text-[10px]">
                        <div className="flex items-center gap-1.5">
                            <span className="w-4 h-4 rounded text-[8px] font-bold flex items-center justify-center text-white" style={{ background: '#3b82f6' }}>M</span>
                            <span style={{ color: '#475569' }}>M√ºhazir…ô: {split.lecture}s ({lecBlocks.full} tam{lecBlocks.half > 0 ? ` + ${lecBlocks.half} yarƒ±m` : ''} blok)</span>
                        </div>
                        <div className="flex items-center gap-1.5">
                            <span className="w-4 h-4 rounded text-[8px] font-bold flex items-center justify-center text-white" style={{ background: '#10b981' }}>S</span>
                            <span style={{ color: '#475569' }}>Seminar: {split.seminar}s ({semBlocks.full} tam{semBlocks.half > 0 ? ` + ${semBlocks.half} yarƒ±m` : ''} blok)</span>
                        </div>
                    </div>
                </div>
                <div className="flex justify-end gap-2 pt-2">
                    <button className="px-4 py-2 rounded-lg text-sm transition" style={{ background: '#e2e8f0', color: '#475569' }} onClick={onClose}>L…ôƒüv et</button>
                    <button className="px-5 py-2 rounded-lg text-sm font-semibold transition disabled:opacity-40" style={{ background: '#4e8bb1', color: '#fff' }} disabled={!subject.trim() || !group.trim()} onClick={handleSave}>{isEdit ? 'Yadda saxla' : '∆èlav…ô et'}</button>
                </div>
            </div>;
        }

        /* ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ */
        function AdminPanel({ open, onClose, teachers, setTeachers, lessons, setLessons, placements, setPlacements, initialTab, initialTeacherId }) {
            const [tab, setTab] = useState(initialTab || 'teachers');
            const [editTeacher, setEditTeacher] = useState(null);
            const [editLesson, setEditLesson] = useState(null);
            const [confirm, setConfirm] = useState(null);
            useEffect(() => { if (open) setTab(initialTab || 'teachers'); }, [open, initialTab]);
            const handleSaveTeacher = (t) => { setTeachers(p => { const e = p.find(x => x.id === t.id); return e ? p.map(x => x.id === t.id ? t : x) : [...p, t] }); setEditTeacher(null); };
            const handleDeleteTeacher = (id) => { setConfirm({ msg: 'Bu m√º…ôllim v…ô d…ôrsl…ôri silin…ôc…ôk. ∆èminsiniz?', onYes: () => { setTeachers(p => p.filter(x => x.id !== id)); setLessons(p => p.filter(x => x.teacherId !== id)); setPlacements(p => p.filter(pl => { const l = lessons.find(x => x.id === pl.lessonId); return l && l.teacherId !== id; })); setConfirm(null); } }); };
            const handleSaveLesson = (l) => { setLessons(p => { const e = p.find(x => x.id === l.id); return e ? p.map(x => x.id === l.id ? l : x) : [...p, l] }); setEditLesson(null); };
            const handleDeleteLesson = (id) => { setConfirm({ msg: 'Bu d…ôrs silin…ôc…ôk. ∆èminsiniz?', onYes: () => { setLessons(p => p.filter(x => x.id !== id)); setPlacements(p => p.filter(x => x.lessonId !== id)); setConfirm(null); } }); };
            if (!open) return null;
            return <Modal open={open} onClose={onClose} title="‚öôÔ∏è Admin Panel" wide>
                {confirm && <div className="fixed inset-0 z-[150] flex items-center justify-center" style={{ background: 'rgba(9,16,27,0.6)' }}>
                    <div className="rounded-xl p-6 w-[380px] max-w-[90vw] shadow-2xl modal-content" style={{ background: '#ffffff', border: '1px solid #e2e8f0' }}>
                        <p className="text-sm mb-5" style={{ color: '#0f172a' }}>{confirm.msg}</p>
                        <div className="flex justify-end gap-2">
                            <button className="px-4 py-1.5 rounded-lg text-sm" style={{ background: '#e2e8f0', color: '#475569' }} onClick={() => setConfirm(null)}>Xeyr</button>
                            <button className="px-4 py-1.5 rounded-lg text-sm font-semibold" style={{ background: '#e31c2d', color: '#fff' }} onClick={confirm.onYes}>B…ôli, Sil</button>
                        </div>
                    </div>
                </div>}
                <div className="flex gap-6 mb-5 -mt-1" style={{ borderBottom: '1px solid #e2e8f0' }}>
                    <button className={`pb-2 text-sm font-semibold transition ${tab === 'teachers' ? 'tab-active' : ''}`} style={tab !== 'teachers' ? { color: '#475569' } : {}} onClick={() => setTab('teachers')}>üë®‚Äçüè´ M√º…ôlliml…ôr ({teachers.length})</button>
                    <button className={`pb-2 text-sm font-semibold transition ${tab === 'lessons' ? 'tab-active' : ''}`} style={tab !== 'lessons' ? { color: '#475569' } : {}} onClick={() => setTab('lessons')}>üìö D…ôrsl…ôr ({lessons.length})</button>
                </div>
                {tab === 'teachers' && <div>{editTeacher !== null ? <TeacherForm teacher={editTeacher.id ? editTeacher : null} onSave={handleSaveTeacher} onClose={() => setEditTeacher(null)} /> : <>
                    <button className="mb-4 px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2" style={{ background: '#4e8bb1', color: '#fff' }} onClick={() => setEditTeacher({})}><span className="text-lg leading-none">+</span> Yeni M√º…ôllim</button>
                    <div className="space-y-2 max-h-[50vh] overflow-y-auto pr-1">{teachers.map(t => {
                        const tC = lessons.filter(l => l.teacherId === t.id).length; return <div key={t.id} className="flex items-center gap-3 p-3 rounded-xl transition group" style={{ background: 'rgba(241,245,249,0.5)', border: '1px solid #e2e8f0' }}>
                            <div className="w-9 h-9 rounded-lg flex items-center justify-center text-sm font-bold shrink-0" style={{ background: t.color + '25', color: t.color }}>{t.name.charAt(0)}</div>
                            <div className="flex-1 min-w-0"><p className="text-sm font-semibold">{t.name}</p>
                                <div className="flex flex-wrap gap-x-3 gap-y-0.5 text-[10px] mt-0.5" style={{ color: '#475569' }}><span>{t.department || '‚Äî'}</span><span>‚Ä¢</span><span>Blok: {(t.blockedSlots || []).length} xana</span><span>‚Ä¢</span><span>{tC} d…ôrs</span></div>
                            </div>
                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition shrink-0">
                                <button className="w-7 h-7 rounded-lg flex items-center justify-center text-xs transition" style={{ background: 'rgba(78,139,177,0.15)', color: '#475569' }} onClick={() => setEditTeacher(t)}>‚úé</button>
                                <button className="w-7 h-7 rounded-lg flex items-center justify-center text-xs transition" style={{ background: 'rgba(227,28,45,0.12)', color: '#f4a4ab' }} onClick={() => handleDeleteTeacher(t.id)}>üóë</button>
                            </div>
                        </div>
                    })}{teachers.length === 0 && <p className="text-center py-8 text-sm" style={{ color: '#475569' }}>He√ß bir m√º…ôllim yoxdur.</p>}</div></>}</div>}
                {tab === 'lessons' && <div>{editLesson !== null ? <LessonForm lesson={editLesson.id ? editLesson : null} teachers={teachers} onSave={handleSaveLesson} onClose={() => setEditLesson(null)} initialTeacherId={initialTeacherId} /> : <>
                    <button className="mb-4 px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2" style={{ background: '#4e8bb1', color: '#fff' }} onClick={() => setEditLesson({})}><span className="text-lg leading-none">+</span> Yeni D…ôrs</button>
                    <div className="space-y-2 max-h-[50vh] overflow-y-auto pr-1">{lessons.map(l => {
                        const t = teachers.find(x => x.id === l.teacherId);
                        const sp = splitHours(l.totalHours || 30);
                        const ph = getPlacedHoursByType(placements, l.id);
                        const isFull = (sp.lecture - ph.lecture) <= 0 && (sp.seminar - ph.seminar) <= 0;
                        return <div key={l.id} className="flex items-center gap-3 p-3 rounded-xl transition group" style={{ background: 'rgba(241,245,249,0.5)', border: '1px solid #e2e8f0' }}>
                            <div className="w-2 h-10 rounded-full shrink-0" style={{ background: t?.color || '#666' }} />
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 flex-wrap"><span className="text-sm font-semibold">{l.subject}</span>{isFull && <span className="text-[9px] px-1.5 rounded-full" style={{ background: 'rgba(92,198,57,0.15)', color: '#5cc639' }}>Tam ‚úì</span>}</div>
                                <div className="flex gap-x-3 text-[10px] mt-0.5" style={{ color: '#475569' }}>
                                    <span>{t?.name || '‚Äî'}</span><span>‚Ä¢</span><span>{l.group}</span><span>‚Ä¢</span>
                                    <span>M:{sp.lecture}s S:{sp.seminar}s</span>
                                </div>
                            </div>
                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition shrink-0">
                                <button className="w-7 h-7 rounded-lg flex items-center justify-center text-xs transition" style={{ background: 'rgba(78,139,177,0.15)', color: '#475569' }} onClick={() => setEditLesson(l)}>‚úé</button>
                                <button className="w-7 h-7 rounded-lg flex items-center justify-center text-xs transition" style={{ background: 'rgba(227,28,45,0.12)', color: '#f4a4ab' }} onClick={() => handleDeleteLesson(l.id)}>üóë</button>
                            </div>
                        </div>
                    })}{lessons.length === 0 && <p className="text-center py-8 text-sm" style={{ color: '#475569' }}>He√ß bir d…ôrs yoxdur.</p>}</div></>}</div>}
            </Modal>;
        }

        /* ‚îÄ‚îÄ Grid Cell ‚îÄ‚îÄ */
        function GridCell({ dayId, slotId, selectedTeacher, placements, draggingLessonId, selectedLessonToPlace, lessons, teachers, onDrop, onRemove }) {
            const [hoverZone, setHoverZone] = useState(null);
            const t = selectedTeacher;
            const isUnavail = t ? !isTeacherAvailable(t, dayId, slotId) : false;
            const isBlocked = isUnavail; // Visual sync
            const isDisabled = isUnavail;
            const evenL = placements.filter(p => p.dayId === dayId && p.slotId === slotId && (p.parity === 'even' || p.parity === 'both') && lessons.find(l => l.id === p.lessonId)?.teacherId == selectedTeacher?.id);
            const oddL = placements.filter(p => p.dayId === dayId && p.slotId === slotId && (p.parity === 'odd' || p.parity === 'both') && lessons.find(l => l.id === p.lessonId)?.teacherId == selectedTeacher?.id);

            const canDrop = useCallback(z => {
                const dropId = draggingLessonId || selectedLessonToPlace;
                if (!dropId || isDisabled) return false;
                const l = lessons.find(x => x.id === dropId); if (!l) return false;
                const lt = teachers.find(x => x.id === l.teacherId); if (lt && !isTeacherAvailable(lt, dayId, slotId)) return false;

                // Get remaining hours by type
                const sp = splitHours(l.totalHours || 30);
                const ph = getPlacedHoursByType(placements, l.id);
                const lecRem = sp.lecture - ph.lecture;
                const semRem = sp.seminar - ph.seminar;
                const rem = lecRem + semRem;
                if (rem <= 0) return false;

                // Check current type's remaining
                const typeRem = lecRem > 0 ? lecRem : semRem;
                if (typeRem < 30 && z === 'full') return false;
                return true;
            }, [draggingLessonId, selectedLessonToPlace, isDisabled, dayId, slotId, lessons, teachers, placements]);

            const onDragOver = (e, z) => { e.preventDefault(); if (canDrop(z)) { e.dataTransfer.dropEffect = 'move'; setHoverZone(z); } };
            const onDropH = (e, z) => { e.preventDefault(); setHoverZone(null); const id = e.dataTransfer.getData('lessonId'); if (id && canDrop(z)) onDrop(id, dayId, slotId, z); };
            const onClickCell = (e) => {
                if (!selectedLessonToPlace || isDisabled) return;
                const l = lessons.find(x => x.id === selectedLessonToPlace); if (!l) return;
                const sp = splitHours(l.totalHours || 30);
                const ph = getPlacedHoursByType(placements, l.id);
                const lecRem = sp.lecture - ph.lecture;
                const semRem = sp.seminar - ph.seminar;
                const typeRem = lecRem > 0 ? lecRem : semRem;
                // auto-detect zone based on remaining hours and empty slots
                let z = 'full';
                if (typeRem < 30 || evenL.length > 0 || oddL.length > 0) z = evenL.length === 0 ? 'even' : 'odd';
                if (canDrop(z)) onDrop(selectedLessonToPlace, dayId, slotId, z);
            };
            const bgS = isBlocked ? '#fef2f2' : isUnavail ? '#f8fafc' : '#ffffff';
            const hover = hoverZone === 'even' ? 'drop-target-even' : hoverZone === 'odd' ? 'drop-target-odd' : hoverZone === 'full' ? 'drop-target-both' : '';
            const pill = (p) => {
                const l = lessons.find(x => x.id === p.lessonId); const tc = teachers.find(x => x.id === l?.teacherId);
                if (!l || !tc) return null;
                const isLec = p.type !== 'seminar';
                const badge = isLec ? { label: 'M', bg: '#3b82f6' } : { label: 'S', bg: '#10b981' };
                return <div key={p.lessonId + p.parity + (p.type || '')} className="placed-pill group/p relative flex items-center gap-0.5 rounded px-1 py-0.5 cursor-pointer hover:brightness-125 transition-all"
                    style={{ background: tc.color + '25', borderLeft: `2px solid ${tc.color}` }} onClick={e => { e.stopPropagation(); onRemove(l.id, p); }}>
                    <span className="w-3 h-3 rounded text-[7px] font-bold flex items-center justify-center text-white shrink-0" style={{ background: badge.bg }}>{badge.label}</span>
                    <span className="text-[8px] font-semibold truncate max-w-[60px]">{l.subject}</span>
                    <button className="absolute -top-1 -right-1 w-3.5 h-3.5 rounded-full text-white text-[8px] flex items-center justify-center opacity-0 group-hover/p:opacity-100 transition-opacity"
                        style={{ background: 'rgba(227,28,45,0.8)' }} onClick={e => { e.stopPropagation(); onRemove(l.id, p); }}>‚úï</button>
                </div>;
            };
            return <div className={`cell-split relative w-full h-[76px] rounded-lg ${hover} transition-colors ${selectedLessonToPlace && canDrop('full') ? 'cursor-pointer hover:bg-slate-200' : selectedLessonToPlace && (canDrop('odd') || canDrop('even')) ? 'cursor-pointer hover:bg-slate-100' : ''}`} style={{ background: bgS, border: '1px solid #e2e8f0' }} onClick={onClickCell}>
                {isBlocked && <div className="blocked-x select-none"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="4" y1="4" x2="20" y2="20" /><line x1="20" y1="4" x2="4" y2="20" /></svg></div>}
                {!isBlocked && <>
                    <div className="cell-even-zone px-1" onDragOver={e => onDragOver(e, 'even')} onDrop={e => onDropH(e, 'even')} onDragLeave={() => setHoverZone(null)}>
                        {evenL.length > 0 ? <div className="flex flex-col gap-0.5 w-full">{evenL.map(pill)}</div> : <span className="text-[8px] select-none" style={{ color: '#475569' }}>alt</span>}
                    </div>
                    <div className="cell-odd-zone px-1" onDragOver={e => onDragOver(e, 'odd')} onDrop={e => onDropH(e, 'odd')} onDragLeave={() => setHoverZone(null)}>
                        {oddL.length > 0 ? <div className="flex flex-col gap-0.5 w-full">{oddL.map(pill)}</div> : <span className="text-[8px] select-none" style={{ color: '#475569' }}>√ºst</span>}
                    </div>
                    {evenL.length === 0 && oddL.length === 0 && <div className="absolute inset-0 z-0" onDragOver={e => onDragOver(e, 'full')} onDrop={e => onDropH(e, 'full')} onDragLeave={() => setHoverZone(null)} />}
                </>}
                {isUnavail && !isBlocked && <div className="absolute inset-0 flex items-center justify-center z-10 pointer-events-none"><span className="text-[9px] px-2 py-0.5 rounded" style={{ color: '#475569', background: 'rgba(248,250,252,0.8)' }}>M√∂vcud deyil</span></div>}
            </div>;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        function App() {
            const [teachers, setTeachers] = useState([]);
            const [lessons, setLessons] = useState([]);
            const [placements, setPlacements] = useState([]);
            const [semesterStart, setSemesterStart] = useState('2026-02-16');
            const [semesterEnd, setSemesterEnd] = useState('2026-05-29');
            const [selectedTeacherId, setSelectedTeacherId] = useState(1);

            const [isLoaded, setIsLoaded] = useState(false);
            const skipNextUpload = useRef(false);

            // Sync FROM Firebase
            useEffect(() => {
                const ref = db.ref('timetableData');
                ref.on('value', snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        skipNextUpload.current = true;

                        // Migrate teachers to new blockedSlots format
                        const migratedTeachers = (data.teachers || INIT_TEACHERS).map(t => {
                            if (!t.blockedSlots && (t.blockedDays || t.availableFrom)) {
                                let slots = [];
                                if (t.blockedDays && t.blockedDays.length) {
                                    t.blockedDays.forEach(d => { SLOTS.forEach((_, sIdx) => slots.push(`${d}-${sIdx}`)); });
                                }
                                if (t.availableFrom && t.availableTo) {
                                    const minF = timeToMin(t.availableFrom), maxT = timeToMin(t.availableTo);
                                    SLOTS.forEach((s, sIdx) => {
                                        const [sh, sm] = s.time.split(' ‚Äì ')[0].split(':').map(Number), [eh, em] = s.time.split(' ‚Äì ')[1].split(':').map(Number);
                                        if (sh * 60 + sm < minF || eh * 60 + em > maxT) DAYS.forEach(d => slots.push(`${d.id}-${sIdx}`));
                                    });
                                }
                                t.blockedSlots = [...new Set([...(t.blockedSlots || []), ...slots])];
                                delete t.blockedDays; delete t.availableFrom; delete t.availableTo;
                            }
                            return t;
                        });

                        setTeachers(migratedTeachers);

                        // Migrate lessons to have totalHours
                        const migratedLessons = (data.lessons || INIT_LESSONS).map(l => {
                            if (!l.totalHours) {
                                l.totalHours = l.parity === 'both' ? 30 : 15;
                                delete l.parity;
                            }
                            return l;
                        });
                        setLessons(migratedLessons);

                        setPlacements(data.placements || []);
                    }
                    setIsLoaded(true);
                });
                return () => ref.off();
            }, []);

            // Sync TO Firebase
            useEffect(() => {
                if (!isLoaded) return;
                if (skipNextUpload.current) {
                    skipNextUpload.current = false;
                    return;
                }
                db.ref('timetableData').set({ teachers, lessons, placements });
            }, [teachers, lessons, placements, isLoaded]);

            const [draggingLessonId, setDraggingLessonId] = useState(null);
            const [selectedLessonToPlace, setSelectedLessonToPlace] = useState(null);
            const [notification, setNotification] = useState(null);
            const [adminOpen, setAdminOpen] = useState(false);
            const [adminTab, setAdminTab] = useState('teachers');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const openAdmin = (tab) => { setAdminTab(tab || 'teachers'); setAdminOpen(true); };

            const selectedTeacher = teachers.find(t => t.id === selectedTeacherId);

            // Available lessons are those that still have remaining hours (lecture or seminar)
            const availableLessons = lessons.filter(l => {
                if (l.teacherId != selectedTeacherId) return false;
                const sp = splitHours(l.totalHours || 30);
                const ph = getPlacedHoursByType(placements, l.id);
                return (sp.lecture - ph.lecture) > 0 || (sp.seminar - ph.seminar) > 0;
            });

            const notify = (msg, type = 'info') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };

            const handleDrop = useCallback((lessonId, dayId, slotId, zone = 'full') => {
                const lesson = lessons.find(l => l.id === lessonId); if (!lesson) return;
                const teacher = teachers.find(t => t.id === lesson.teacherId);
                if (teacher && !isTeacherAvailable(teacher, dayId, slotId)) { notify(`${teacher.name} bu saatda m√∂vcud deyil!`, 'error'); return; }

                // Determine type (lecture first, then seminar)
                const split = splitHours(lesson.totalHours || 30);
                const placed = getPlacedHoursByType(placements, lesson.id);
                const lecRem = split.lecture - placed.lecture;
                const semRem = split.seminar - placed.seminar;
                const dropType = lecRem > 0 ? 'lecture' : 'seminar';
                const rem = lecRem + semRem;

                let finalParity = zone === 'full' ? 'both' : zone;
                const typeRem = dropType === 'lecture' ? lecRem : semRem;
                if (zone === 'full' && typeRem < 30) {
                    const hasEven = placements.some(x => x.dayId === dayId && x.slotId === slotId && (x.parity === 'even' || x.parity === 'both'));
                    finalParity = hasEven ? 'odd' : 'even';
                }

                const tc = placements.filter(p => { if (p.dayId !== dayId || p.slotId !== slotId) return false; const pl = lessons.find(l => l.id === p.lessonId); return pl && pl.teacherId === lesson.teacherId && parityConflicts(pl.parity, finalParity); });
                if (tc.length > 0) { notify('M√º…ôllim bu slotda m…ô≈üƒüuldur!', 'error'); return; }
                const gc = placements.filter(p => { if (p.dayId !== dayId || p.slotId !== slotId) return false; const pl = lessons.find(l => l.id === p.lessonId); return pl && pl.group === lesson.group && parityConflicts(pl.parity, finalParity); });
                if (gc.length > 0) { notify(`${lesson.group} qrupunun d…ôrsi var!`, 'error'); return; }

                // Check anti-consecutive: same subject M and S must not be adjacent
                if (hasAdjacentSameSubject(placements, lesson.id, dayId, slotId, finalParity)) {
                    notify(`${lesson.subject} √º√ß√ºn M√ºhazir…ô v…ô Seminar ardƒ±cƒ±l saatlara d√º≈ü…ô bilm…ôz!`, 'error'); return;
                }

                setPlacements(prev => [...prev, { lessonId, dayId, slotId, parity: finalParity, type: dropType }]);
                const typeLabel = dropType === 'lecture' ? 'M√ºhazir…ô' : 'Seminar';
                const sessions = getSessionCount(finalParity);
                notify(`${lesson.subject} (${typeLabel} ${finalParity === 'both' ? '30s' : '15s'}, ${sessions}x) yerl…ô≈üdirildi ‚úì`, 'success');

                // If it's now fully placed, deselect
                const newPlacedH = (finalParity === 'both' ? 30 : 15);
                if (rem - newPlacedH <= 0) {
                    setSelectedLessonToPlace(null);
                }
            }, [placements, lessons, teachers]);

            const handleRemove = useCallback((id, specificPlacement = null) => {
                setPlacements(prev => {
                    if (specificPlacement) {
                        return prev.filter(p => p !== specificPlacement);
                    }
                    return prev.filter(p => p.lessonId !== id);
                });
            }, []);

            const autoSchedule = useCallback(() => {
                if (!selectedTeacher || availableLessons.length === 0) return;
                let newPlacements = [...placements];
                let placedCount = 0;

                function tryPlace(lesson, hours, type) {
                    let rem = hours;
                    while (rem >= 15) {
                        let placed = false;
                        const wantsFull = rem >= 30;
                        const paritiesToTry = wantsFull ? ['both', 'even', 'odd'] : ['even', 'odd'];

                        // Sort days by how many blocks this lesson already has there (balance)
                        const sortedDays = [...DAYS].sort((a, b) => {
                            return countOnDay(newPlacements, lesson.id, a.id) - countOnDay(newPlacements, lesson.id, b.id);
                        });

                        for (const requiredParity of paritiesToTry) {
                            for (const day of sortedDays) {
                                for (let slotIdx = 0; slotIdx < SLOTS.length; slotIdx++) {
                                    if (!isTeacherAvailable(selectedTeacher, day.id, slotIdx)) continue;

                                    const teacherConflict = newPlacements.some(p => {
                                        if (p.dayId !== day.id || p.slotId !== slotIdx) return false;
                                        const pl = lessons.find(l => l.id === p.lessonId);
                                        return pl && pl.teacherId === lesson.teacherId && parityConflicts(pl.parity, requiredParity);
                                    });
                                    if (teacherConflict) continue;

                                    const groupConflict = newPlacements.some(p => {
                                        if (p.dayId !== day.id || p.slotId !== slotIdx) return false;
                                        const pl = lessons.find(l => l.id === p.lessonId);
                                        return pl && pl.group === lesson.group && parityConflicts(pl.parity, requiredParity);
                                    });
                                    if (groupConflict) continue;

                                    // Anti-consecutive: same subject M/S must not be adjacent
                                    if (hasAdjacentSameSubject(newPlacements, lesson.id, day.id, slotIdx, requiredParity)) continue;

                                    newPlacements.push({ lessonId: lesson.id, dayId: day.id, slotId: slotIdx, parity: requiredParity, type });
                                    placed = true;
                                    placedCount++;
                                    rem -= (requiredParity === 'both' ? 30 : 15);
                                    break;
                                }
                                if (placed) break;
                            }
                            if (placed) break;
                        }
                        if (!placed) break;
                    }
                }

                // For each lesson: place lecture blocks first, then seminar blocks
                for (const lesson of availableLessons) {
                    const split = splitHours(lesson.totalHours || 30);
                    const placed = getPlacedHoursByType(newPlacements, lesson.id);
                    const lecRem = split.lecture - placed.lecture;
                    const semRem = split.seminar - placed.seminar;
                    if (lecRem > 0) tryPlace(lesson, lecRem, 'lecture');
                    if (semRem > 0) tryPlace(lesson, semRem, 'seminar');
                }

                if (placedCount > 0) {
                    setPlacements(newPlacements);
                    notify(`${placedCount} blok (M√ºhazir…ô+Seminar) aƒüƒ±llƒ± yerl…ô≈üdirildi ü™Ñ`, 'success');
                } else {
                    notify('Uyƒüun bo≈ü xana tapƒ±lmadƒ±!', 'error');
                }
            }, [selectedTeacher, availableLessons, placements, lessons, notify]);

            useEffect(() => { const h = () => setDraggingLessonId(null); document.addEventListener('dragend', h); return () => document.removeEventListener('dragend', h); }, []);
            useEffect(() => { if (!teachers.find(t => t.id === selectedTeacherId) && teachers.length > 0) setSelectedTeacherId(teachers[0].id); }, [teachers, selectedTeacherId]);

            // Stats calculation for display
            let tTotalH = 0;
            let tPlacedH = 0;
            lessons.filter(l => l.teacherId == selectedTeacherId).forEach(l => {
                tTotalH += (l.totalHours || 0);
            });
            placements.forEach(p => {
                const l = lessons.find(x => x.id === p.lessonId);
                if (l && l.teacherId == selectedTeacherId) {
                    tPlacedH += (p.parity === 'both' ? 30 : 15);
                }
            });
            const stats = { total: tTotalH, placed: tPlacedH };

            return <div className="min-h-screen flex flex-col" style={{ background: '#f8fafc' }}>
                {notification && <Toast msg={notification.msg} type={notification.type} />}
                <AdminPanel open={adminOpen} onClose={() => setAdminOpen(false)} teachers={teachers} setTeachers={setTeachers} lessons={lessons} setLessons={setLessons} placements={placements} setPlacements={setPlacements} initialTab={adminTab} initialTeacherId={selectedTeacherId} />

                {/* HEADER */}
                <header className="print-hide" style={{ borderBottom: '1px solid #e2e8f0', background: 'rgba(255,255,255,0.85)', backdropFilter: 'blur(20px)' }}>
                    <div className="max-w-[1600px] mx-auto flex items-center justify-between px-4 py-3 sm:px-6">
                        <div className="flex items-center gap-3">
                            {/* Mobile menu btn */}
                            <button className="sm:hidden w-9 h-9 rounded-lg flex items-center justify-center" style={{ background: 'rgba(78,139,177,0.1)' }} onClick={() => setSidebarOpen(true)}>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2"><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="18" x2="21" y2="18" /></svg>
                            </button>
                            <div className="w-9 h-9 rounded-xl flex items-center justify-center" style={{ background: 'linear-gradient(135deg,#4e8bb1,#4075bf)' }}>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round"><rect x="3" y="4" width="18" height="18" rx="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></svg>
                            </div>
                            <div className="hidden sm:block">
                                <h1 className="text-lg font-bold" style={{ background: 'linear-gradient(90deg,#0f172a,#475569)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>Aƒüƒ±llƒ± D…ôrs C…ôdv…ôli</h1>
                                <p className="text-[11px]" style={{ color: '#475569' }}>Drag & Drop il…ô interaktiv redaktor</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 sm:gap-3">
                            <div className="text-right mr-1 sm:mr-2">
                                <p className="text-[10px] sm:text-xs" style={{ color: '#475569' }}>Yerl…ô≈üdiril…ôn (saat)</p>
                                <p className="text-base sm:text-lg font-bold">
                                    {placements.reduce((s, x) => s + (x.parity === 'both' ? 30 : 15), 0)}
                                    <span className="text-sm" style={{ color: '#475569' }}>/{lessons.reduce((s, x) => s + (x.totalHours || 0), 0)}</span>
                                </p>
                            </div>
                            <button className="px-2 sm:px-3 py-1.5 rounded-lg text-[10px] sm:text-xs font-semibold transition flex items-center gap-1.5"
                                style={{ background: 'rgba(78,139,177,0.1)', border: '1px solid rgba(78,139,177,0.15)', color: '#475569' }} onClick={() => openAdmin('teachers')}>
                                <span>‚öôÔ∏è</span><span className="hidden sm:inline">Admin Panel</span>
                            </button>
                            <button className="px-2 sm:px-3 py-1.5 rounded-lg text-[10px] sm:text-xs font-medium transition"
                                style={{ background: 'rgba(227,28,45,0.08)', border: '1px solid rgba(233,73,87,0.15)', color: '#ee7781' }}
                                onClick={() => { setPlacements([]); notify('C…ôdv…ôl sƒ±fƒ±rlandƒ±', 'info'); }}>Sƒ±fƒ±rla</button>
                        </div>
                    </div>
                    <div className="max-w-[1600px] mx-auto flex items-center justify-between px-4 pb-2 sm:px-6" style={{ marginTop: '-4px' }}>
                        <div className="flex items-center gap-2 text-[10px]" style={{ color: '#475569' }}>
                            <span className="font-medium">Semestr:</span>
                            <input type="date" value={semesterStart} onChange={e => setSemesterStart(e.target.value)}
                                className="rounded px-1.5 py-0.5 text-[10px]" style={{ background: '#f1f5f9', border: '1px solid #e2e8f0', color: '#0f172a' }} />
                            <span>‚Äî</span>
                            <input type="date" value={semesterEnd} onChange={e => setSemesterEnd(e.target.value)}
                                className="rounded px-1.5 py-0.5 text-[10px]" style={{ background: '#f1f5f9', border: '1px solid #e2e8f0', color: '#0f172a' }} />
                            <span className="ml-1 px-1.5 py-0.5 rounded text-[9px] font-semibold" style={{ background: '#dbeafe', color: '#3b82f6' }}>
                                {(() => { const d = Math.ceil((new Date(semesterEnd) - new Date(semesterStart)) / (7 * 24 * 60 * 60 * 1000)); return `${d} h…ôft…ô`; })()}
                            </span>
                        </div>
                        <div className="flex items-center gap-2 text-[9px]" style={{ color: '#475569' }}>
                            <span className="flex items-center gap-1"><span className="w-3 h-3 rounded text-[7px] font-bold flex items-center justify-center text-white" style={{ background: '#3b82f6' }}>M</span>M√ºhazir…ô</span>
                            <span className="flex items-center gap-1"><span className="w-3 h-3 rounded text-[7px] font-bold flex items-center justify-center text-white" style={{ background: '#10b981' }}>S</span>Seminar</span>
                        </div>
                    </div>
                </header>

                <div className="flex-1 flex max-w-[1600px] mx-auto w-full relative">
                    {/* Mobile sidebar overlay */}
                    <div className={`sidebar-overlay ${sidebarOpen ? 'open' : ''}`} onClick={() => setSidebarOpen(false)} />

                    {/* SIDEBAR */}
                    <aside className={`app-sidebar ${sidebarOpen ? 'open' : ''} w-[280px] flex flex-col`} style={{ borderRight: '1px solid #e2e8f0', background: 'rgba(255,255,255,0.95)' }}>
                        {/* Mobile close */}
                        <div className="sm:hidden flex justify-end p-3"><button className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ background: '#e2e8f0', color: '#475569' }} onClick={() => setSidebarOpen(false)}>‚úï</button></div>

                        <div className="p-4" style={{ borderBottom: '1px solid #e2e8f0' }}>
                            <div className="flex items-center justify-between mb-3">
                                <h2 className="text-xs font-semibold uppercase tracking-wider" style={{ color: '#475569' }}>M√º…ôlliml…ôr</h2>
                                <button className="text-[10px] transition" style={{ color: '#4e8bb1' }} onClick={() => openAdmin('teachers')}>+ ∆èlav…ô et</button>
                            </div>
                            <div className="flex flex-col gap-1.5">{teachers.map(t => {
                                const isA = t.id === selectedTeacherId;
                                const tP = placements.filter(p => { const l = lessons.find(x => x.id === p.lessonId); return l && l.teacherId == t.id; }).reduce((s, p) => s + (p.parity === 'both' ? 30 : 15), 0);
                                const tT = lessons.filter(l => l.teacherId == t.id).reduce((s, l) => s + (l.totalHours || 0), 0);
                                return <button key={t.id} onClick={() => { setSelectedTeacherId(t.id); setSidebarOpen(false); }}
                                    className={`flex items-center gap-2.5 px-3 py-2 rounded-lg text-left transition-all ${isA ? 'teacher-active' : ''}`}
                                    style={isA ? { background: 'rgba(78,139,177,0.12)' } : { background: 'transparent' }}>
                                    <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold" style={{ background: t.color + '25', color: t.color }}>{t.name.charAt(0)}</div>
                                    <div className="flex-1 min-w-0"><p className="text-xs font-semibold truncate">{t.name}</p><p className="text-[10px]" style={{ color: '#475569' }}>{t.department}</p></div>
                                    <span className="text-[10px] font-medium" style={{ color: '#475569' }}>{tP}/{tT}s</span>
                                </button>;
                            })}</div>
                        </div>

                        {selectedTeacher && <div className="p-4" style={{ borderBottom: '1px solid #e2e8f0' }}>
                            <div className="rounded-lg p-3 space-y-2" style={{ background: '#ffffff' }}>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <div className="w-6 h-6 rounded-md flex items-center justify-center" style={{ background: selectedTeacher.color + '25' }}><span className="text-xs" style={{ color: selectedTeacher.color }}>‚Ñπ</span></div>
                                        <span className="text-xs font-semibold" style={{ color: '#475569' }}>{selectedTeacher.name}</span>
                                    </div>
                                    <button className="text-[10px]" style={{ color: '#4e8bb1' }} onClick={() => openAdmin('teachers')}>Redakt…ô ‚úé</button>
                                </div>
                                <div className="text-[10px] space-y-1" style={{ color: '#475569' }}>
                                    <p><span className="font-medium">M√∂vcudluq qadaƒüalarƒ±: </span>{(selectedTeacher.blockedSlots || []).length > 0 ? `${(selectedTeacher.blockedSlots || []).length} xana bloklanƒ±b` : 'Tam s…ôrb…ôst'}</p>
                                </div>
                                <div className="pt-1">
                                    <div className="flex justify-between text-[10px] mb-1" style={{ color: '#475569' }}><span>T…ôr…ôqqi</span><span>{stats.placed}/{stats.total}</span></div>
                                    <div className="h-1 rounded-full overflow-hidden mb-2.5" style={{ background: '#e2e8f0' }}><div className="h-full rounded-full transition-all duration-500" style={{ width: `${stats.total > 0 ? (stats.placed / stats.total) * 100 : 0}%`, background: selectedTeacher.color }} /></div>
                                    <div className="flex gap-1.5 w-full mt-2">
                                        <button className="flex-1 py-1.5 rounded text-[10px] font-medium transition flex items-center justify-center gap-1 hover:brightness-95"
                                            style={{ background: '#e2e8f0', color: '#475569' }} onClick={() => window.print()}>
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                            Y√ºkl…ô
                                        </button>
                                        <button className="flex-1 py-1.5 rounded text-[10px] font-medium transition text-white hover:brightness-110 disabled:opacity-50"
                                            style={{ background: 'linear-gradient(135deg,#4e8bb1,#4075bf)' }} disabled={availableLessons.length === 0} onClick={autoSchedule}>
                                            ü™Ñ Aƒüƒ±llƒ± d√ºz
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>}

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="flex items-center justify-between mb-3">
                                <h2 className="text-xs font-semibold uppercase tracking-wider" style={{ color: '#475569' }}>D…ôrsl…ôr ({availableLessons.length})</h2>
                                <button className="text-[10px]" style={{ color: '#4e8bb1' }} onClick={() => openAdmin('lessons')}>+ Yeni</button>
                            </div>
                            {availableLessons.length === 0
                                ? <div className="text-center py-8"><p className="text-xs" style={{ color: '#475569' }}>B√ºt√ºn d…ôrsl…ôr yerl…ô≈üdirilib ‚úì</p></div>
                                : <div className="flex flex-col gap-2">{availableLessons.map(l => {
                                    const sp = splitHours(l.totalHours || 30);
                                    const ph = getPlacedHoursByType(placements, l.id);
                                    const lecRem = sp.lecture - ph.lecture;
                                    const semRem = sp.seminar - ph.seminar;
                                    return <div key={l.id} className={`lesson-card group rounded-lg p-2.5 cursor-pointer transition-all ${selectedLessonToPlace === l.id ? 'ring-2 ring-emerald-500 bg-slate-100 shadow-md transform scale-[1.02]' : 'hover:-translate-y-0.5 hover:shadow-lg bg-slate-50'}`}
                                        draggable onDragStart={e => { e.dataTransfer.setData('lessonId', l.id); e.dataTransfer.effectAllowed = 'move'; setDraggingLessonId(l.id); }}
                                        onClick={() => { setSelectedLessonToPlace(l.id); setSidebarOpen(false); notify(l.subject + ' se√ßildi. Yerl…ô≈üdirm…ôk √º√ß√ºn c…ôdv…ôld…ô yuvaya klikl…ôyin.', 'info'); }}
                                        style={{ border: '1px solid #e2e8f0', borderLeftColor: teachers.find(t => t.id === l.teacherId)?.color || '#666', borderLeftWidth: '4px' }}>
                                        <div className="flex items-center justify-between mb-1"><span className="font-semibold text-xs">{l.subject}</span><span className="text-[10px] py-0.5 px-1.5 rounded bg-slate-200 text-slate-600">{l.totalHours}s</span></div>
                                        <div className="flex items-center gap-2 text-[10px]" style={{ color: '#475569' }}>
                                            <span>{l.group}</span><span>‚Ä¢</span>
                                            <span className="flex items-center gap-0.5"><span className="w-2.5 h-2.5 rounded text-[6px] font-bold flex items-center justify-center text-white" style={{ background: '#3b82f6' }}>M</span>{lecRem > 0 ? `${lecRem}s` : '‚úì'}</span>
                                            <span className="flex items-center gap-0.5"><span className="w-2.5 h-2.5 rounded text-[6px] font-bold flex items-center justify-center text-white" style={{ background: '#10b981' }}>S</span>{semRem > 0 ? `${semRem}s` : '‚úì'}</span>
                                        </div>
                                        {(() => { const lPl = placements.filter(x => x.lessonId === l.id); if (lPl.length === 0) return null; const totalSessions = lPl.reduce((s, p) => s + getSessionCount(p.parity), 0); return <div className="flex items-center gap-1 mt-1 text-[9px]" style={{ color: '#94a3b8' }}><span>üìÖ {totalSessions} d…ôrs</span><span>‚Ä¢ {Math.round(totalSessions * BLOCK_MINUTES / 60)}s faktiki</span></div>; })()}
                                    </div>
                                })}</div>}
                        </div>

                        <div className="p-4" style={{ borderTop: '1px solid #e2e8f0' }}>
                            <h3 className="text-[10px] uppercase tracking-wider mb-2" style={{ color: '#475569' }}>R…ông ƒ∞zahƒ±</h3>
                            <div className="space-y-1.5">
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded" style={{ background: '#fef2f2', border: '1px solid rgba(233,73,87,0.15)' }} /><span className="text-[10px]" style={{ color: '#475569' }}>Bloklanan g√ºn</span></div>
                                <div className="flex items-center gap-2"><ParityBadge parity="even" small /><span className="text-[10px]" style={{ color: '#475569' }}>‚Äî √ºst yarƒ±</span></div>
                                <div className="flex items-center gap-2"><ParityBadge parity="odd" small /><span className="text-[10px]" style={{ color: '#475569' }}>‚Äî alt yarƒ±</span></div>
                            </div>
                        </div>
                    </aside>

                    {/* GRID */}
                    <main className="grid-main flex-1 p-4 sm:p-6 overflow-auto">

                        <div className="print-header">
                            <h1>{selectedTeacher?.name || 'M√º…ôllim'}</h1>
                            <p>{selectedTeacher?.department || 'C…ôdv…ôli'}</p>
                        </div>

                        <div style={{ minWidth: '700px' }}>
                            <div className="grid gap-1.5" style={{ gridTemplateColumns: '70px repeat(5,1fr)' }}>
                                <div />
                                {DAYS.map(day => {
                                    const bl = (selectedTeacher?.blockedDays || []).includes(day.id);
                                    return <div key={day.id} className="text-center py-2 rounded-lg" style={{ background: bl ? '#fef2f2' : '#ffffff' }}>
                                        <p className="text-xs font-bold" style={{ color: bl ? '#ee7781' : '#0f172a' }}>{day.short}</p>
                                        <p className="text-[10px]" style={{ color: '#475569' }}>{day.name}</p>
                                    </div>;
                                })}
                            </div>
                            <div className="mt-3 mb-1.5 flex items-center gap-2 px-1">
                                <span className="text-[10px] font-semibold uppercase tracking-widest" style={{ color: '#475569' }}>S…ôh…ôr</span>
                                <div className="flex-1 h-px" style={{ background: '#e2e8f0' }} />
                            </div>
                            {SLOTS.map((slot, idx) => <React.Fragment key={slot.id}>
                                {idx === 3 && <div className="mt-3 mb-1.5 flex items-center gap-2 px-1"><span className="text-[10px] font-semibold uppercase tracking-widest" style={{ color: '#475569' }}>G√ºnorta</span><div className="flex-1 h-px" style={{ background: '#e2e8f0' }} /></div>}
                                <div className="grid gap-1.5 mb-1.5" style={{ gridTemplateColumns: '70px repeat(5,1fr)' }}>
                                    <div className="flex flex-col items-center justify-center rounded-lg px-2 py-1" style={{ background: '#ffffff' }}>
                                        <span className="text-sm font-bold">{slot.num}</span>
                                        <span className="text-[9px] leading-tight text-center" style={{ color: '#475569' }}>{slot.time}</span>
                                    </div>
                                    {DAYS.map(day => <GridCell key={`${day.id}-${slot.id}`} dayId={day.id} slotId={slot.id}
                                        selectedTeacher={selectedTeacher} placements={placements} draggingLessonId={draggingLessonId} selectedLessonToPlace={selectedLessonToPlace}
                                        lessons={lessons} teachers={teachers} onDrop={handleDrop} onRemove={handleRemove} />)}
                                </div>
                            </React.Fragment>)}
                        </div>
                    </main>
                </div>
            </div>;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>